/** Preferred Networks, Inc. All rights reserved. */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("babylonjs"),require("babylonjs-materials"),require("babylonjs-loaders"),require("babylonjs-gui")):"function"==typeof define&&define.amd?define(["babylonjs","babylonjs-materials","babylonjs-loaders","babylonjs-gui"],n):(e||self).VViewer=n(e.BABYLON,e.MATERIALS,e.LOADERS,e.BABYLON.GUI)}(this,function(e,n,t,r){function i(e){if(e&&e.__esModule)return e;var n=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})}}),n.default=e,n}var o=/*#__PURE__*/i(e),s=/*#__PURE__*/i(n),a=/*#__PURE__*/i(t),l=/*#__PURE__*/i(r);function c(){return c=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},c.apply(this,arguments)}function u(e,n){if(null==e)return{};var t,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n.indexOf(t=o[r])>=0||(i[t]=e[t]);return i}const d=["onResize","onCreate","antialias"],h=e=>{e.resize()},g=function(e,n){let t=void 0===n?{}:n,{onResize:r=h,onCreate:i,antialias:s=!0}=t,a=u(t,d);const l=new o.Engine(e,s,c({antialias:s},a));if(r){const e=()=>{r(l)};window.addEventListener("resize",e),l.onDisposeObservable.addOnce(()=>{window.removeEventListener("resize",e)}),e()}return null==i||i(l),l},f=e=>e instanceof o.Color3?e:new o.Color3(e.r,e.g,e.b),m=e=>e instanceof o.Color4?e:e.toColor4();function p(e){return/^(?:\/|\w+:)/.test(e)}function b(e){const n=/^(\w+:)(\/\/[^/]+\/?|[\\/])/.exec(e);return n?"\\"===n[2]?n[1]+"/":n[0]:e.startsWith("/")?"/":""}function v(e){const n=b(e);return""+n+e.slice(n.length).replace(/\/?([^/]+)\/*$/,"")||"."}function C(e){const n=b(e),t=/[^/.](\.\w*)$/.exec(e.slice(n.length));return t?t[1]:""}function y(e){const n=b(e);let t=e.slice(n.length).replace(/[\\/]+/g,"/");n&&(t=t.replace(/^(?:\/\.{0,2})+/,""));const r=[];return t.split("/").forEach(e=>{"."===e?r.length||r.push(e):".."===e?r.length&&".."!==r[r.length-1]?r.pop():n||r.push(e):(""!==e&&"."===r[r.length-1]&&r.pop(),r.push(e))}),n+r.join("/")||"."}function x(){return y([].slice.call(arguments).join("/"))}function L(){var e=[].slice.call(arguments);let n=e.length-1;for(;!p(e[n])&&n>0;n-=1);const t=b(e[n]);if("/"===t){let t=n-1;for(;t>=0;t-=1){const r=e[t];if(p(r)){const t=b(r);if("/"!==t)return x(""+t.replace(/\/$/,"")+e[n],...e.slice(n+1))}}}return x(...e.slice(n))}const M=["groundColor","skyboxColor","environmentTexture","onCreate"],E=(e,n)=>{if("string"==typeof n){const t=C(n);switch(t){case".env":return o.CubeTexture.CreateFromPrefilteredData(n,e);case".hdr":return new o.HDRCubeTexture(n,e,128,!1,!0,!1,!0);default:throw new Error("Not support extension: "+t+" ("+n+")")}}return n},w=function(e,n){let t=void 0===n?{}:n,{groundColor:r,skyboxColor:i,environmentTexture:o,onCreate:s}=t,a=u(t,M);const l=e.createDefaultEnvironment(c({createGround:!1,groundSize:1,groundColor:f(r||e.clearColor).toLinearSpace(),groundOpacity:.5,enableGroundShadow:!1,groundMirrorBlurKernel:32,groundMirrorAmount:2,createSkybox:!1,skyboxColor:f(i||e.clearColor).toLinearSpace(),environmentTexture:o?E(e,o):void 0},a));return null==s||s(l),l},O=function(e,n){let{pbr:t=!0,scale:r=1e4,blur:i=.15,setGlobalEnvTexture:o=!0,onCreate:s}=void 0===n?{}:n;const a=e.createDefaultSkybox(e.environmentTexture,t,r,i,o);return null==s||s(a),a},T=["clearColor","environmentTexture","debugLayerVisiblity"],R=["skipFrustumClipping","clearColor","environmentTexture","debugLayerVisiblity","onRender","onCreate"],P=(e,n)=>{n?e.debugLayer.show({embedMode:!0}):e.debugLayer.hide()},A=function(e,n){let t=void 0===n?{}:n,{clearColor:r,environmentTexture:i,debugLayerVisiblity:o}=t,s=u(t,T);void 0!==r&&(e.clearColor=m(r).toLinearSpace()),void 0!==i&&(e.environmentTexture=null!==i?E(e,i):null),void 0!==o&&P(e,o),Object.assign(e,s)},S=e=>{e.render()},k=function(e,n){let t=void 0===n?{}:n,{skipFrustumClipping:r=!0,clearColor:i,environmentTexture:s,debugLayerVisiblity:a=!1,onRender:l=S,onCreate:c}=t,d=u(t,R);const h=new o.Scene(e,d);return A(h,{skipFrustumClipping:r,clearColor:i,environmentTexture:s,debugLayerVisiblity:a}),l&&h.whenReadyAsync(!0).then(()=>{h.onNewMeshAddedObservable.addOnce(()=>{h.getEngine().runRenderLoop(()=>{l(h)})})}),null==c||c(h),h},j=["createArcRotateCamera","replace","attachCameraControls","autoFocus","focusMesh","radius","onCreate"],F=e=>{const{meshes:n}=e,t=[];n.forEach((e,n)=>{try{const r=e.visibility;e.visibility=0,t.push([n,r])}catch(e){}}),e.render(),t.forEach(e=>{let[t,r]=e;n[t].visibility=r})},B=function(e,n){let{prerender:t=!1}=void 0===n?{}:n;if(e.meshes.length){t&&F(e);const n=e.activeCamera;n.lowerRadiusLimit=null;const r=n.getBehaviorByName("Framing"),i=e.getWorldExtends(e=>e.isVisible&&e.isEnabled()&&!(e.material instanceof s.GridMaterial)&&!/^Background/.test(e.name));r.framingTime=0,r.elevationReturnTime=-1,r.zoomOnBoundingInfo(i.min,i.max)}},I=function(e,n){let t=void 0===n?{}:n,{createArcRotateCamera:r=!0,replace:i,attachCameraControls:o=!0,radius:s=1,onCreate:a}=t,l=u(t,j);e.createDefaultCamera(r,i,o);const d=e.activeCamera;Object.assign(d,c({alpha:Math.PI/2,beta:Math.PI/2,radius:s,pinchPrecision:200/d.radius,upperRadiusLimit:5*d.radius,lowerRadiusLimit:null,wheelDeltaPercentage:.01,pinchDeltaPercentage:.01,useFramingBehavior:!0,useAutoRotationBehavior:!1},l)),null==a||a(d)},D=function(e,n){let{name:t="default",hdr:r=!0,imageProcessingExposure:i=1.5,samples:s=1,fxaaEnabled:a=!0,sharpenEnabled:l=!0,sharpenEdgeAmount:c=.2,onCreate:u}=void 0===n?{}:n;const d=new o.DefaultRenderingPipeline(t,r,e,e.cameras);return d.imageProcessing.exposure=i,d.samples=s,d.fxaaEnabled=a,d.sharpenEnabled=l,d.sharpen.edgeAmount=c,null==u||u(d),d},U=function(e,n){let{name:t="GridMesh",width:r=1,height:i=0,subdivisions:a=1,scaling:l=1,majorUnitFrequency:c=5,minorUnitVisibility:u=.25,opacity:d=.5,gridRatio:h=.02,mainColor:g=o.Color3.White(),lineColor:m=o.Color3.White(),onCreate:p}=void 0===n?{}:n;const b=o.MeshBuilder.CreateGround(t,{width:r,height:i,subdivisions:a},e);b.scaling.x=l,b.scaling.z=b.scaling.x,b.isPickable=!1;const v=new s.GridMaterial(t+"Material",e);return v.majorUnitFrequency=c,v.minorUnitVisibility=u,v.opacity=d,v.gridRatio=h*b.scaling.x,v.mainColor=f(g),v.lineColor=f(m),v.backFaceCulling=!1,b.material=v,null==p||p(b),b},_=function(e,n){let{replace:t=!1,onCreate:r}=void 0===n?{}:n;const i=t||!e.lights.length;e.createDefaultLight(t),i&&(null==r||r(e.lights[e.lights.length-1]))},N=function(e,n){let{name:t="DirectionalLight",direction:r=new o.Vector3(1,-1,0),onCreate:i}=void 0===n?{}:n;const s=new o.DirectionalLight(t,r,e);return null==i||i(s),s},z=e=>e.lights.filter(e=>e instanceof o.DirectionalLight),V=(e,n)=>{z(e).forEach(e=>{switch(n){case"realistic":case"flat":e.intensity=0;break;default:e.intensity=1}})},G=function(e,n){let{name:t="",shadingMode:r,texture:i=null,color:s=null}=void 0===n?{}:n;const a=f(s||o.Color3.Gray());switch(r){case"realistic":{const n=new o.PBRMetallicRoughnessMaterial(t,e);return i&&(n.baseTexture=i),n.baseColor=i?o.Color3.White():a,n}case"flat":{const n=new o.StandardMaterial(t,e);return n.emissiveTexture=i,n.emissiveColor=i?o.Color3.Black():a,n}default:{const n=new o.StandardMaterial(t,e);return n.diffuseTexture=i,n.diffuseColor=i?o.Color3.White():a,n}}},H=function(e,n){void 0===n&&(n={}),e.meshes.length&&e.textures.length&&(e.materials.forEach(e=>{e.dispose()}),e.materials.splice(0,e.materials.length),e.materials.push(G(e.scene,c({texture:e.textures[0]||null},n))),e.meshes.forEach(n=>{n.material=e.materials[0]||null}))},W=(e,n)=>new o.Texture(n,e,void 0,void 0,o.Texture.NEAREST_SAMPLINGMODE),q=()=>{a.OBJFileLoader.OPTIMIZE_WITH_UV=!0,a.OBJFileLoader.COMPUTE_NORMALS=!0,a.OBJFileLoader.OPTIMIZE_NORMALS=!0,a.OBJFileLoader.INVERT_Y=!0,a.OBJFileLoader.SKIP_MATERIALS=!0},J=function(e,n){let{subSurface:t={}}=void 0===n?{}:n;e.forEach(e=>{t&&e.material instanceof o.PBRMaterial&&Object.assign(e.material.subSurface,c({indexOfRefraction:1.5,volumeIndexOfRefraction:1.5,refractionTexture:null},t))})},$=function(e,n){let{name:t=null,rootUrl:r,onProgress:i,pluginExtension:s}=void 0===n?{}:n;try{let n,a;if(e instanceof File)n=r||"",a=e;else{if(n=null!=r?r:e.replace(/[/]+$/,""),!e.startsWith(n))throw new Error("URL "+e+" is not included in Root URL "+n);a=e.slice(n.length)}return Promise.resolve(o.SceneLoader.ImportMeshAsync(t,n,a,void 0,i,s))}catch(e){return Promise.reject(e)}},Y=function(e,n,t){void 0===t&&(t={});try{return Promise.resolve(o.Tools.LoadFileAsync(n,!1)).then(function(r){const i=v(n),o=String(r).replace(/^(map_\w+\s+)(.+)$/gm,(e,n,r)=>{const o=t[r]||r;return n+(p(o)?o:L(i,o))}),s=new a.MTLFileLoader;s.parseMTL(e.scene,o,"",e),e.materials.push(...s.materials)})}catch(e){return Promise.reject(e)}},Z=function(e,n,t){let{name:r,rootUrl:i,onProgress:s,pluginExtension:a,mtlUrl:l,mtlUrlTable:c,textureUrl:u,subSurface:d,shadingMode:h="standard"}=void 0===t?{}:t;return Promise.resolve($(n,{name:r,rootUrl:i,onProgress:s,pluginExtension:a})).then(function(n){function t(){return J(r.meshes,{subSurface:d}),r}const r=new o.AssetContainer(e);r.meshes.push(...n.meshes);const i=function(){if(l||u){function n(){i.forEach(e=>{let[n,r]=e;t[n].visibility=r})}const{meshes:t}=r,i=[];t.forEach((e,n)=>{try{const t=e.visibility;e.visibility=0,i.push([n,t])}catch(e){}});const o=function(){if(l)return Promise.resolve(Y(r,l,c)).then(function(){r.meshes.forEach(e=>{e.material=r.materials[0]||null})});u&&(r.textures.push(W(e,u)),H(r,{shadingMode:h}))}();return o&&o.then?o.then(n):n()}}();return i&&i.then?i.then(t):t()})},K=(e,n)=>{let{name:t,text:r,width:i,height:o,margin:s,fontSize:a,cornerRadius:c,color:u,background:d,horizontalAlignment:h,verticalAlignment:g,onClick:f}=n;const m=l.AdvancedDynamicTexture.CreateFullscreenUI(t+"UI",void 0,e),p=new l.StackPanel;p.width=i+s+s+"px",p.height=o+s+s+"px",p.paddingTop=s+"px",p.paddingRight=s+"px",p.paddingBottom=s+"px",p.paddingLeft=s+"px",p.horizontalAlignment=h,p.verticalAlignment=g,m.addControl(p);const b=l.Button.CreateSimpleButton(t+"Button",r);b.width=i+"px",b.height=o+"px",b.fontSize=a+"px",b.cornerRadius=c,b.color=u,b.background=d,b.onPointerUpObservable.add(f),p.addControl(b)},Q=function(e,n){void 0===n&&(n={}),K(e,c({name:"DebugLayerSwitch",text:"Toggle Debug Layer",width:128,height:24,margin:12,fontSize:12,cornerRadius:4,color:"#cccccc",background:"#222222",horizontalAlignment:l.Control.HORIZONTAL_ALIGNMENT_RIGHT,verticalAlignment:l.Control.VERTICAL_ALIGNMENT_TOP,onClick:()=>{P(e,!e.debugLayer.isVisible())}},n))},X=function(e,n){let{scene:t=null,sceneLoadedCallback:r=null,progressCallback:i=null,additionalRenderLoopLogicCallback:s=null,textureLoadingCallback:a=null,startingProcessingFilesCallback:l=null,onReloadCallback:c=null,errorCallback:u=null,onProcessFileCallback:d,loadAsync:h,onCreate:g}=void 0===n?{}:n;const f=new o.FilesInput(e,t,r,i,s,a,l,c,u);return d&&(f.onProcessFileCallback=d),h&&(f.loadAsync=h),null==g||g(f),f};var ee={__proto__:null,createEngine:g,updateDebugLayer:P,updateScene:A,createScene:k,renderEmptyScene:F,focusMeshes:B,createCamera:I,createEnvironmentTexture:E,createEnvironment:w,createSkybox:O,createDefaultRenderingPipeline:D,createGrid:U,createLight:_,createDirectionalLight:N,getDirectionalLights:z,updateDirectionalLights:V,setupOBJFileLoaderOptions:q,updateMeshes:J,importMeshFileAsync:$,importMTLFileAsync:Y,importMeshAsync:Z,createTexture:W,createMaterial:G,updateMaterial:H,createSimpleButton:K,createDebugLayerSwitchButton:Q,createFilesInput:X,toColor3:f,toColor4:m,isAbsolute:p,basename:function(e,n){void 0===n&&(n="");const t=b(e),r=/([^/]*)\/*$/.exec(e.slice(t.length)),i=r?r[1]:"";return n&&i.endsWith(n)?i.slice(0,-n.length):i},dirname:v,extname:C,normalize:y,join:x,resolve:L,relative:function(e,n){const t=b(e),r=b(n);if(t!==r)return n;const i=L("/",e),o=L("/",n);if(i===o)return"";const s=i.slice(t.length),a=o.slice(r.length),l=s.split("/").filter(e=>e),c=a.split("/").filter(e=>e);let u=0;for(const e=Math.min(l.length,c.length);u<e&&l[u]===c[u];u+=1);const d=l.length-u,h=[];for(let e=0;e<d;e+=1)h.push("..");return h.concat(c.slice(u)).join("/")}};const ne=()=>{q()};class te{constructor(e,n){const t=this;let{setupOptions:r=ne,engine:i,scene:s={},camera:a={},light:l=null,environment:u=null,skybox:d=null,defaultPipeline:h={},grid:f=null,directionalLight:m={},filesInput:p=null,debugLayerSwitchButton:b=!1,shadingMode:v="standard"}=void 0===n?{}:n;this.containers=void 0,this.onMeshLoadedObservable=void 0,this.shadingMode=void 0,this.engine=void 0,this.scene=void 0,this.environmentHelper=void 0,this.filesInput=void 0,r(),this.containers=[],this.onMeshLoadedObservable=new o.Observable,this.engine=g(e,i);const C=e=>{const n=k(e,s);a&&I(n,a),l&&_(n,l);const t=u?w(n,u):void 0;return d&&O(n,d),h&&D(n,h),f&&U(n,f),m&&N(n,m),b&&Q(n),[n,t]};if([this.scene,this.environmentHelper]=C(this.engine),p){const e=this.engine.getRenderingCanvas();if(e){const n=X(this.engine,c({},p,{loadAsync:function(e,n){try{return t.disposeContainers(),t.disposeScenes(),[t.scene,t.environmentHelper]=C(t.engine),Promise.resolve(t.importMeshAsync(e,{rootUrl:"file:",onProgress:n})).then(function(){return t.scene})}catch(e){return Promise.reject(e)}}}));n.monitorElementForDragNDrop(e),this.filesInput=n}}this.onMeshLoadedObservable.add(e=>{if(this.environmentHelper&&this.environmentHelper.groundMirrorRenderList){const{groundMirrorRenderList:n}=this.environmentHelper;e.meshes.forEach(e=>{n.push(e)})}this.containers.push(e)}),a&&a.autoFocus&&this.onMeshLoadedObservable.add(()=>{B(this.scene,a.focusMesh)}),this.shadingMode=v}disposeContainers(){this.containers.forEach(e=>{e.dispose()}),this.containers.splice(0,this.containers.length)}disposeScenes(){this.engine.scenes.forEach(e=>{e.cameras.forEach(e=>{e.detachControl()}),e.dispose()})}dispose(){this.disposeContainers(),this.disposeScenes(),this.engine.dispose()}updateOptions(e){let{scene:n,shadingMode:t}=e;n&&this.engine.scenes.forEach(e=>{A(e,n)}),null!=t&&this.shadingMode!==t&&(this.shadingMode=t,this.containers.forEach(e=>{H(e,{shadingMode:t})}),V(this.scene,t))}focusMesh(e){void 0===e&&(e={}),B(this.scene,e)}importMeshAsync(e,n){void 0===n&&(n={});try{const t=this;return Promise.resolve(t.scene.whenReadyAsync(!0)).then(function(){return Promise.resolve(Z(t.scene,e,n)).then(function(e){return Promise.resolve(t.onMeshLoadedObservable.notifyObserversWithPromise(e)).then(function(){return e})})})}catch(e){return Promise.reject(e)}}}return te.utils=ee,te});
